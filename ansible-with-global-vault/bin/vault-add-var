#!/bin/bash
# Add a variable to a vault file with interactive prompts

# Get the script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$( cd "${SCRIPT_DIR}/.." && pwd )"

# Default vault file
DEFAULT_VAULT_FILE="group_vars/all/vault.yml"
VAULT_FILE="${1:-${DEFAULT_VAULT_FILE}}"
VAULT_FILE_PATH="${PROJECT_ROOT}/${VAULT_FILE}"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "=== Add Variable to Vault ==="
echo ""

# Check if vault file exists
if [ ! -f "${VAULT_FILE_PATH}" ]; then
    echo -e "${RED}Error: Vault file not found: ${VAULT_FILE}${NC}"
    exit 1
fi

# Prompt for feature
echo -n "Enter feature name: "
read -r FEATURE

if [ -z "${FEATURE}" ]; then
    echo -e "${RED}Error: Feature name cannot be empty${NC}"
    exit 1
fi

# Prompt for group
echo -n "Enter group name: "
read -r GROUP

if [ -z "${GROUP}" ]; then
    echo -e "${RED}Error: Group name cannot be empty${NC}"
    exit 1
fi

# Prompt for name
echo -n "Enter variable name: "
read -r NAME

if [ -z "${NAME}" ]; then
    echo -e "${RED}Error: Variable name cannot be empty${NC}"
    exit 1
fi

# Prompt for value
echo -n "Enter variable value: "
read -r VALUE

if [ -z "${VALUE}" ]; then
    echo -e "${RED}Error: Variable value cannot be empty${NC}"
    exit 1
fi

# Construct the full variable name
VAR_NAME="vault_${FEATURE}_${GROUP}_${NAME}"

echo ""
echo -e "${YELLOW}Variable to be added:${NC}"
echo "  Name:  ${VAR_NAME}"
echo "  Value: \"${VALUE}\""
echo "  File:  ${VAULT_FILE}"
echo ""

# Confirm before proceeding
echo -n "Add this variable? (y/n): "
read -r CONFIRM

if [ "${CONFIRM}" != "y" ] && [ "${CONFIRM}" != "Y" ]; then
    echo "Cancelled."
    exit 0
fi

# Create a temporary file
TEMP_FILE=$(mktemp)

# Decrypt vault file to temp file
"${PROJECT_ROOT}/.venv/bin/ansible-vault" decrypt "${VAULT_FILE_PATH}" --output="${TEMP_FILE}" 2>/dev/null

if [ $? -ne 0 ]; then
    echo -e "${RED}Error: Failed to decrypt vault file${NC}"
    rm -f "${TEMP_FILE}"
    exit 1
fi

# Check if variable already exists
if grep -q "^${VAR_NAME}:" "${TEMP_FILE}"; then
    echo -e "${RED}Error: Variable '${VAR_NAME}' already exists in vault file${NC}"
    rm -f "${TEMP_FILE}"
    exit 1
fi

# Add the new variable to the temp file
echo "" >> "${TEMP_FILE}"
echo "# ${FEATURE} - ${GROUP}" >> "${TEMP_FILE}"
echo "${VAR_NAME}: \"${VALUE}\"" >> "${TEMP_FILE}"

# Re-encrypt the vault file
"${PROJECT_ROOT}/.venv/bin/ansible-vault" encrypt "${TEMP_FILE}" --output="${VAULT_FILE_PATH}" 2>/dev/null

if [ $? -ne 0 ]; then
    echo -e "${RED}Error: Failed to encrypt vault file${NC}"
    rm -f "${TEMP_FILE}"
    exit 1
fi

# Clean up
rm -f "${TEMP_FILE}"

echo -e "${GREEN}Success!${NC}"
echo "Variable '${VAR_NAME}' added to ${VAULT_FILE}"
echo ""
echo "View the updated file:"
echo "  ./bin/vault-view ${VAULT_FILE}"
