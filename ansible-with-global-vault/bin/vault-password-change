#!/bin/bash
# Change the vault password and create a timestamped backup of the old password

# Get the script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$( cd "${SCRIPT_DIR}/.." && pwd )"

VAULT_PASSWORD_FILE="${PROJECT_ROOT}/.vault/password"

# Check if new password parameter is provided
if [ -z "$1" ]; then
    echo "Error: New password required"
    echo "Usage: $0 <new-password>"
    echo ""
    echo "Description:"
    echo "  Changes the vault password stored in .vault/password"
    echo "  and creates a timestamped backup of the old password."
    echo ""
    echo "  After changing the password, you must rekey all encrypted"
    echo "  files using the vault-rekey script."
    echo ""
    echo "Example:"
    echo "  $0 my-new-secure-password"
    echo ""
    echo "Then rekey encrypted files:"
    echo "  ./bin/vault-rekey group_vars/all/vault.yml"
    exit 1
fi

NEW_PASSWORD="$1"

# Check if password file exists
if [ ! -f "${VAULT_PASSWORD_FILE}" ]; then
    echo "Error: Vault password file not found: ${VAULT_PASSWORD_FILE}"
    exit 1
fi

# Generate timestamp for backup
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="${VAULT_PASSWORD_FILE}.${TIMESTAMP}"

# Create backup of old password
echo "Creating backup: .vault/password.${TIMESTAMP}"
cp "${VAULT_PASSWORD_FILE}" "${BACKUP_FILE}"

if [ $? -ne 0 ]; then
    echo "Error: Failed to create backup"
    exit 1
fi

# Write new password
echo "${NEW_PASSWORD}" > "${VAULT_PASSWORD_FILE}"

if [ $? -ne 0 ]; then
    echo "Error: Failed to write new password"
    echo "Restoring backup..."
    mv "${BACKUP_FILE}" "${VAULT_PASSWORD_FILE}"
    exit 1
fi

# Ensure proper permissions
chmod 600 "${VAULT_PASSWORD_FILE}"

echo "Success!"
echo "  Old password backed up to: .vault/password.${TIMESTAMP}"
echo "  New password written to: .vault/password"
echo ""
echo "IMPORTANT: You must now rekey all encrypted files with the new password."
echo "Example:"
echo "  ./bin/vault-rekey group_vars/all/vault.yml"
