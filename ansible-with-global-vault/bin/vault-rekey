#!/bin/bash
# Rekey an encrypted vault file (change the encryption password)

# Get the script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$( cd "${SCRIPT_DIR}/.." && pwd )"

# Check if file parameter is provided
if [ -z "$1" ]; then
    echo "Error: File path required"
    echo "Usage: $0 <file>"
    echo ""
    echo "Description:"
    echo "  Changes the vault password used to encrypt a file."
    echo "  You will be prompted for the old password and new password."
    echo ""
    echo "Note:"
    echo "  If using a vault password file, update .vault/password first,"
    echo "  then run this command. It will prompt for the OLD password"
    echo "  and use the NEW password from .vault/password."
    echo ""
    echo "Example:"
    echo "  $0 group_vars/all/vault.yml"
    exit 1
fi

FILE="$1"

# Check if file exists
if [ ! -f "${PROJECT_ROOT}/${FILE}" ]; then
    echo "Error: File not found: ${FILE}"
    exit 1
fi

echo "Rekeying: ${FILE}"
echo "You will be prompted for the current (old) vault password."
echo "The file will be re-encrypted with the password from .vault/password"
echo ""

# Rekey the file using ansible-vault
"${PROJECT_ROOT}/.venv/bin/ansible-vault" rekey "${PROJECT_ROOT}/${FILE}"
